{% extends "base.html" %}

{% block title %}Willkommen ‚Äì Wunsch‚ÄëAutomatisierungen{% endblock %}

{% block content %}
<!-- Page Loader -->
<div class="page-loader">
    <div class="modern-loader"></div>
    <div class="loader-text">Versicherungsmakler Finder wird geladen...</div>
</div>

<!-- Welcome Hero -->
<section class="hero-section py-5">
    <div class="container text-center">
        <h1 class="display-5 fw-bold text-gradient mb-3">
            <i class="fas fa-wand-magic-sparkles me-2"></i>
            Willkommen bei Wunsch‚ÄëAutomatisierungen
        </h1>
        <p class="lead text-muted mb-4">
            Smarte Web‚ÄëAutomatisierungen und Tools ‚Äì schnell, einfach, professionell.
        </p>
        <div class="d-flex flex-wrap justify-content-center gap-2">
            <a href="#suche" class="btn btn-primary btn-lg hover-lift">
                <i class="fas fa-search me-2"></i>
                Makler‚ÄëSuche starten
            </a>
            <a href="{{ url_for('upload_excel') }}" class="btn btn-outline-success btn-lg hover-lift">
                <i class="fas fa-cloud-upload-alt me-2"></i>
                Excel Upload
            </a>
            <a href="{{ url_for('api_settings') }}" class="btn btn-outline-secondary btn-lg hover-lift">
                <i class="fas fa-cog me-2"></i>
                API Einstellungen
            </a>
            <a href="{{ url_for('api_test_connection') }}" class="btn btn-outline-info btn-lg hover-lift">
                <i class="fas fa-flask me-2"></i>
                API Test
            </a>
        </div>
    </div>
    <div class="container mt-4">
        <!-- Selection Menu Cards -->
        <div class="row">
            <div class="col-md-3 mb-3">
                <div class="card h-100 glass-effect hover-lift text-center">
                    <div class="card-body d-flex flex-column">
                        <div class="mb-3"><i class="fas fa-shield-alt fa-2x text-primary"></i></div>
                        <h5 class="mb-2">Versicherungsmakler Finder</h5>
                        <p class="text-muted small mb-3">Makler in Ihrer N√§he finden, Details anreichern und exportieren.</p>
                        <a href="#suche" class="btn btn-primary mt-auto">
                            <i class="fas fa-search me-1"></i>√ñffnen
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card h-100 glass-effect hover-lift text-center">
                    <div class="card-body d-flex flex-column">
                        <div class="mb-3"><i class="fas fa-file-excel fa-2x text-success"></i></div>
                        <h5 class="mb-2">Excel Upload</h5>
                        <p class="text-muted small mb-3">Bestehende Listen hochladen und automatisch erg√§nzen.</p>
                        <a href="{{ url_for('upload_excel') }}" class="btn btn-success mt-auto">
                            <i class="fas fa-cloud-upload-alt me-1"></i>√ñffnen
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card h-100 glass-effect hover-lift text-center">
                    <div class="card-body d-flex flex-column">
                        <div class="mb-3"><i class="fas fa-cogs fa-2x text-secondary"></i></div>
                        <h5 class="mb-2">API Einstellungen</h5>
                        <p class="text-muted small mb-3">Endpunkte konfigurieren und Format w√§hlen.</p>
                        <a href="{{ url_for('api_settings') }}" class="btn btn-outline-secondary mt-auto">
                            <i class="fas fa-cog me-1"></i>√ñffnen
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card h-100 glass-effect hover-lift text-center">
                    <div class="card-body d-flex flex-column">
                        <div class="mb-3"><i class="fas fa-flask fa-2x text-info"></i></div>
                        <h5 class="mb-2">API Test</h5>
                        <p class="text-muted small mb-3">Verbindung mit Beispieldaten pr√ºfen.</p>
                        <a href="{{ url_for('api_test_connection') }}" class="btn btn-outline-info mt-auto">
                            <i class="fas fa-play me-1"></i>Starten
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="row justify-content-center" id="suche">
    <div class="col-md-10 col-lg-8">
        <!-- Header -->
        <div class="text-center mb-5">
            <h1 class="text-gradient mb-3">
                <i class="fas fa-shield-alt me-2"></i>Versicherungsmakler Finder
            </h1>
            <p class="lead">Finden Sie schnell und einfach qualifizierte Versicherungsmakler in Ihrer N√§he</p>
        </div>

    <!-- Hauptsuchformular -->
        <div class="card shadow-strong mb-4 glass-effect">
            <div class="card-header bg-primary text-white text-center">
                <h3><i class="fas fa-search me-2"></i>Makler-Suche starten</h3>
                <p class="mb-0">Nutzen Sie unsere intelligente Suche f√ºr beste Ergebnisse</p>
            </div>
            <div class="card-body p-4">
                <form method="POST" action="{{ url_for('search_brokers') }}" id="searchForm" class="needs-validation" novalidate>
                    <!-- Standort-Eingabe mit Verbesserungen -->
                    <div class="mb-4">
                        <label for="location" class="form-label fw-bold">
                            <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                            Standort
                        </label>
                        <div class="input-group">
                <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="location" 
                                   name="location" 
                    placeholder="z.B. 21641 Apensen oder Musterstra√üe 1, 21641 Apensen" 
                                   required
                                   autocomplete="address-level2"
                                   value="{{ request.form.location if request.form.location }}">
                            <button class="btn btn-outline-secondary" type="button" id="locationButton" title="Standort wird geladen...">
                                <i class="fas fa-crosshairs"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Adresse, Postleitzahl + Ort eingeben (z.B. "21641 Apensen" oder "Musterstra√üe 1, 21641 Apensen"). 
                            <span class="text-primary">Tipp:</span> Nutzen Sie den Standort-Button f√ºr automatische Erkennung.
                        </div>
                        <div class="invalid-feedback">
                            Bitte geben Sie einen g√ºltigen Standort ein (Postleitzahl oder Ortsname).
                        </div>
                    </div>
                    
                    <!-- Erweiterte Radius-Steuerung -->
                    <div class="mb-4">
                        <label for="radius" class="form-label fw-bold">
                            <i class="fas fa-circle-notch me-2 text-primary"></i>
                            Suchradius: <span id="radiusLabel" class="text-primary">{{ request.form.radius if request.form.radius else '10' }} km</span>
                        </label>
                        
                        <div class="row align-items-center">
                            <div class="col-8">
                                <input type="range" 
                                       class="form-range" 
                                       id="radius" 
                                       name="radius" 
                                       min="1" 
                                       max="100" 
                                       step="1"
                                       value="{{ request.form.radius if request.form.radius else '10' }}"
                                       oninput="updateRadiusDisplay(this.value)">
                                <div class="d-flex justify-content-between text-muted small">
                                    <span>1 km</span>
                                    <span>25 km</span>
                                    <span>50 km</span>
                                    <span>100 km</span>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="input-group">
                                    <input type="number" 
                                           class="form-control" 
                                           id="radiusInput"
                                           min="1" 
                                           max="100" 
                                           value="{{ request.form.radius if request.form.radius else '10' }}"
                                           onchange="updateRadiusSlider(this.value)">
                                    <span class="input-group-text">km</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-text">
                            <i class="fas fa-lightbulb me-1"></i>
                            Empfohlen: 10-25 km f√ºr St√§dte, 25-50 km f√ºr l√§ndliche Gebiete
                        </div>
                    </div>
                    
                    <!-- Such-Optionen -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-filter me-2 text-primary"></i>
                            Suchoptionen (optional)
                        </label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="onlyWithEmail" name="onlyWithEmail">
                                    <label class="form-check-label" for="onlyWithEmail">
                                        <i class="fas fa-envelope me-1"></i>Nur mit E-Mail
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="onlyWithWebsite" name="onlyWithWebsite">
                                    <label class="form-check-label" for="onlyWithWebsite">
                                        <i class="fas fa-globe me-1"></i>Nur mit Website
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="onlyWithRating" name="onlyWithRating">
                                    <label class="form-check-label" for="onlyWithRating">
                                        <i class="fas fa-star me-1"></i>Nur bewertete Makler
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="saveSearch" name="saveSearch" checked>
                                    <label class="form-check-label" for="saveSearch">
                                        <i class="fas fa-save me-1"></i>Suche speichern
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Suchbutton mit verbessertem Design -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg hover-lift" id="searchButton">
                            <i class="fas fa-search me-2"></i>
                            Versicherungsmakler finden
                            <span class="badge bg-light text-primary ms-2">Kostenlos</span>
                        </button>
                    </div>
                </form>
                
                <!-- Letzte Suchen (falls vorhanden) -->
                <div id="recentSearches" class="mt-4" style="display: none;">
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">
                            <i class="fas fa-history me-2 text-secondary"></i>Letzte Suchen
                        </h6>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearRecentSearches()">
                            <i class="fas fa-trash me-1"></i>L√∂schen
                        </button>
                    </div>
                    <div id="recentSearchesList" class="d-flex flex-wrap gap-2"></div>
                </div>
            </div>
        </div>
        
        <!-- Info-Karten mit erweiterten Features -->
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card h-100 glass-effect hover-lift">
                    <div class="card-body text-center">
                        <div class="feature-icon mb-3">
                            <i class="fas fa-map-marker-alt fa-3x text-primary"></i>
                        </div>
                        <h5>Pr√§zise Lokalisierung</h5>
                        <p class="card-text text-muted">
                            Intelligente Standorterkennung mit Google Maps API f√ºr exakte Umkreissuche und Routenplanung.
                        </p>
                        <div class="mt-auto">
                            <span class="badge bg-primary-subtle text-primary">Google Maps Integration</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 mb-4">
                <div class="card h-100 glass-effect hover-lift">
                    <div class="card-body text-center">
                        <div class="feature-icon mb-3">
                            <i class="fas fa-spider fa-3x text-success"></i>
                        </div>
                        <h5>Detaillierte Daten</h5>
                        <p class="card-text text-muted">
                            Automatisches Web-Scraping f√ºr vollst√§ndige Kontaktinformationen, E-Mails und Ansprechpartner.
                        </p>
                        <div class="mt-auto">
                            <span class="badge bg-success-subtle text-success">KI-gest√ºtzte Extraktion</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 mb-4">
                <div class="card h-100 glass-effect hover-lift">
                    <div class="card-body text-center">
                        <div class="feature-icon mb-3">
                            <i class="fas fa-download fa-3x text-info"></i>
                        </div>
                        <h5>Flexible Exporte</h5>
                        <p class="card-text text-muted">
                            Ergebnisse als Excel oder JSON exportieren. API-Integration f√ºr automatische Weiterverarbeitung.
                        </p>
                        <div class="mt-auto">
                            <span class="badge bg-info-subtle text-info">Excel & JSON & API</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- API Information f√ºr Entwickler -->
        <div class="mt-4 text-center">
            <details class="text-start">
                <summary class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-code me-1"></i>API f√ºr Entwickler
                </summary>
                <div class="mt-3 p-3 bg-light rounded">
                    <h6>Programmatischer Zugriff</h6>
                    <p class="small">
                        Diese Anwendung bietet auch eine REST-API f√ºr die Integration in Ihre Systeme:
                    </p>
                    <ul class="small text-muted">
                        <li><code>GET /api/brokers</code> - Makler-Daten abrufen</li>
                        <li><code>POST /api/forward</code> - Daten an externe API weiterleiten</li>
                        <li><code>GET /export/json</code> - JSON-Export</li>
                        <li><code>GET /export/excel</code> - Excel-Export</li>
                    </ul>
                    <a href="{{ url_for('api_settings') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-cog me-1"></i>API konfigurieren
                    </a>
                </div>
            </details>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Enhanced Index Page JavaScript - Version 2.2 (Koordinierte Initialisierung)
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Index Page: DOMContentLoaded triggered');
    
    // Verhindere mehrfache Seiteninitialisierung
    if (window.indexPageInitialized) {
        console.log('‚ÑπÔ∏è Index page bereits initialisiert, √ºberspringe...');
        return;
    }
    window.indexPageInitialized = true;
    
    // Warte auf globale App-Initialisierung mit Timeout
    let waitAttempts = 0;
    const maxWaitAttempts = 100; // 5 Sekunden bei 50ms Intervall
    
    const waitForApp = () => {
        waitAttempts++;
        
        if (window.appInitialized) {
            console.log('‚è≥ Index Page: App initialisiert, starte seitenspezifische Initialisierung...');
            
            // Delay initialization to ensure all DOM elements are ready
            setTimeout(() => {
                console.log('‚è≥ Index Page: Starting delayed initialization...');
                loadRecentSearches();
                
                // Debug geolocation setup
                console.log('üó∫Ô∏è Index Page: Setting up geolocation...');
                setupGeolocation();
                
                setupFormEnhancements();
                setupKeyboardShortcuts();
                
                console.log('‚úÖ Index Page: All initialization complete');
            }, 100);
        } else if (waitAttempts >= maxWaitAttempts) {
            console.warn('‚ö†Ô∏è Index Page: Timeout waiting for app initialization, starting anyway...');
            
            // Fallback initialization
            setTimeout(() => {
                console.log('üîÑ Index Page: Fallback initialization...');
                loadRecentSearches();
                setupGeolocation();
                setupFormEnhancements();
                setupKeyboardShortcuts();
                console.log('‚úÖ Index Page: Fallback initialization complete');
            }, 100);
        } else {
            console.log(`‚è≥ Index Page: Warte auf globale App-Initialisierung... (${waitAttempts}/${maxWaitAttempts})`);
            setTimeout(waitForApp, 50);
        }
    };
    
    waitForApp();
});

// Load and display recent searches with Utils availability check
function loadRecentSearches() {
    // Check if Utils is available, if not, retry after a short delay
    if (typeof Utils === 'undefined') {
        console.log('‚è≥ Utils not available yet, retrying in 50ms...');
        setTimeout(() => loadRecentSearches(), 50);
        return;
    }
    
    console.log('üìã Loading recent searches...');
    const recentSearches = Utils.storage.get('recentSearches') || [];
    
    if (recentSearches.length > 0) {
        const container = document.getElementById('recentSearches');
        const list = document.getElementById('recentSearchesList');
        
        if (container && list) {
            container.style.display = 'block';
            list.innerHTML = '';
            
            recentSearches.slice(0, 5).forEach(search => {
                const badge = document.createElement('button');
                badge.className = 'btn btn-outline-primary btn-sm hover-lift';
                badge.innerHTML = `<i class="fas fa-map-marker-alt me-1"></i>${search.location} (${search.radius}km)`;
                badge.onclick = () => fillSearchForm(search);
                list.appendChild(badge);
            });
            
            console.log('‚úÖ Recent searches loaded:', recentSearches.length);
        } else {
            console.warn('‚ö†Ô∏è Recent searches container elements not found');
        }
    } else {
        console.log('‚ÑπÔ∏è No recent searches found');
    }
}

function fillSearchForm(search) {
    document.getElementById('location').value = search.location;
    document.getElementById('radius').value = search.radius;
    document.getElementById('radiusInput').value = search.radius;
    updateRadiusDisplay(search.radius);
    
    Utils.showToast(`Suche geladen: ${search.location}`, 'success');
    document.getElementById('location').focus();
}

function clearRecentSearches() {
    Utils.storage.remove('recentSearches');
    document.getElementById('recentSearches').style.display = 'none';
    Utils.showToast('Suchverlauf gel√∂scht', 'info');
}

// Geolocation setup
// Setup geolocation functionality with enhanced debugging
function setupGeolocation() {
    console.log('üó∫Ô∏è setupGeolocation: Function called');
    
    const locationButton = document.getElementById('locationButton');
    console.log('üîç setupGeolocation: Button element:', locationButton);
    
    if (!locationButton) {
        console.error('‚ùå setupGeolocation: Location button not found in DOM');
        return;
    }
    
    console.log('üì± setupGeolocation: Checking geolocation API support...');
    if (!navigator.geolocation) {
        console.warn('‚ö†Ô∏è setupGeolocation: Geolocation not supported by browser');
        locationButton.disabled = true;
        locationButton.innerHTML = '<i class="fas fa-times"></i>';
        locationButton.title = 'Geolocation wird von diesem Browser nicht unterst√ºtzt';
        return;
    }
    
    console.log('‚úÖ setupGeolocation: Geolocation API is supported');
    locationButton.title = 'Aktuellen Standort verwenden - Klicken Sie hier und erlauben Sie den Zugriff';
    locationButton.disabled = false;
    
    // Check if event listener already exists
    const hasListener = locationButton.getAttribute('data-listener');
    console.log('üéØ setupGeolocation: Existing listener:', hasListener);
    
    if (!hasListener) {
        console.log('‚ûï setupGeolocation: Adding click event listener...');
        
        locationButton.addEventListener('click', function(e) {
            console.log('üñ±Ô∏è LocationButton: Click event triggered!');
            e.preventDefault();
            e.stopPropagation();
            
            console.log('üìç LocationButton: Calling getCurrentLocation...');
            getCurrentLocation();
        });
        
        locationButton.setAttribute('data-listener', 'true');
        console.log('‚úÖ setupGeolocation: Event listener successfully attached');
    } else {
        console.log('‚ÑπÔ∏è setupGeolocation: Event listener already exists');
    }
    
    // Additional visual feedback
    locationButton.addEventListener('mouseenter', function() {
        console.log('üñ±Ô∏è LocationButton: Mouse enter');
    });
    
    locationButton.addEventListener('mouseleave', function() {
        console.log('üñ±Ô∏è LocationButton: Mouse leave');
    });
    
    console.log('üéâ setupGeolocation: Setup complete');
}

async function getCurrentLocation() {
    const button = document.getElementById('locationButton');
    const originalContent = button.innerHTML;
    
    // Check if geolocation is available
    if (!navigator.geolocation) {
        showLocationToast('Geolocation wird von diesem Browser nicht unterst√ºtzt', 'error');
        return;
    }

    // Check if we're on a secure context (HTTPS or localhost)
    const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.hostname.includes('localhost');
    const isHttps = location.protocol === 'https:';
    
    // Modern browsers allow geolocation on localhost even over HTTP
    if (!isSecureContext && !isLocalhost && !isHttps) {
        showLocationToast('Geolocation erfordert HTTPS oder localhost. Aktuelle URL: ' + location.origin, 'warning');
        // Don't return - try anyway on localhost
        if (!isLocalhost) {
            return;
        }
    }
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    try {
        // First check permissions API if available
        if ('permissions' in navigator) {
            try {
                const permissionStatus = await navigator.permissions.query({name: 'geolocation'});
                console.log('Geolocation permission status:', permissionStatus.state);
                
                if (permissionStatus.state === 'denied') {
                    showLocationToast('Standortzugriff wurde verweigert. Bitte aktivieren Sie die Berechtigung in den Browser-Einstellungen und laden Sie die Seite neu.', 'error');
                    resetLocationButton();
                    return;
                }
            } catch (permError) {
                console.log('Permissions API check failed:', permError);
                // Continue anyway, permissions API might not be fully supported
            }
        }
        
        // Show user-friendly prompt first
        console.log('Starting geolocation request...');
        showLocationToast('Bitte erlauben Sie den Standortzugriff im Browser-Dialog', 'info');
        
        // Debug: Log browser and security context info
        console.log('Geolocation request starting...');
        console.log('Browser context:', {
            protocol: location.protocol,
            hostname: location.hostname,
            isSecureContext: isSecureContext,
            geolocationSupported: !!navigator.geolocation,
            userAgent: navigator.userAgent.substring(0, 50),
            isLocalhost: isLocalhost
        });
        
        // Show info about geolocation availability
        if (isLocalhost && location.protocol === 'http:') {
            console.log('‚ÑπÔ∏è HTTP auf localhost - Geolocation sollte verf√ºgbar sein');
        } else if (isHttps) {
            console.log('‚úÖ HTTPS - Geolocation voll verf√ºgbar');
        }
        
        // Add timeout wrapper for better error handling
        const timeoutId = setTimeout(() => {
            showLocationToast('Standort-Abfrage dauert zu lange. Versuchen Sie es erneut.', 'warning');
            resetLocationButton();
        }, 15000);
        
        navigator.geolocation.getCurrentPosition(
            (position) => {
                clearTimeout(timeoutId);
                const { latitude, longitude } = position.coords;
                
                // Reverse Geocoding (hier w√ºrden Sie normalerweise eine API verwenden)
                // F√ºr Demo-Zwecke verwenden wir Koordinaten
                const locationInput = document.getElementById('location');
                locationInput.value = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                
                showLocationToast('Standort erfolgreich ermittelt', 'success');
                
                button.innerHTML = '<i class="fas fa-check text-success"></i>';
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.disabled = false;
                }, 2000);
            },
            (error) => {
                clearTimeout(timeoutId);
                let message = 'Standort konnte nicht ermittelt werden';
                let toastType = 'error';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message = 'Standortzugriff wurde verweigert!';
                        toastType = 'warning';
                        // Show detailed help after a short delay
                        setTimeout(() => {
                            if (confirm('M√∂chten Sie eine Anleitung zur Aktivierung des Standortzugriffs sehen?')) {
                                showGeolocationHelp();
                            }
                        }, 2000);
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message = 'Standort nicht verf√ºgbar. Pr√ºfen Sie Ihre GPS/WLAN-Verbindung und versuchen Sie es erneut.';
                        break;
                    case error.TIMEOUT:
                        message = 'Standort-Abfrage zu langsam. Bitte versuchen Sie es erneut.';
                        break;
                    default:
                        message = 'Unbekannter Fehler bei der Standort-Ermittlung. Code: ' + error.code;
                        break;
                }
                
                console.error('Geolocation error:', error);
                showLocationToast(message, toastType);
                
                button.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i>';
                setTimeout(() => {
                    resetLocationButton();
                }, 3000);
            },
            {
                enableHighAccuracy: true,
                timeout: 12000,
                maximumAge: 300000 // 5 minutes cache
            }
        );
        
    } catch (error) {
        console.error('Geolocation setup error:', error);
        showLocationToast('Fehler beim Initialisieren der Standort-Funktion', 'error');
        resetLocationButton();
    }
    
    function resetLocationButton() {
        button.innerHTML = originalContent;
        button.disabled = false;
    }
}

// Safe location toast function
function showLocationToast(message, type = 'info') {
    try {
        // Try to use Utils if available
        if (typeof Utils !== 'undefined' && Utils.showToast) {
            Utils.showToast(message, type);
            return;
        }
    } catch (e) {
        console.log('Utils not available for location toast');
    }
    
    // Fallback: use simple console log or alert
    console.log(`Location ${type}: ${message}`);
    
    // Create a simple notification for important messages
    if (type === 'error' || type === 'warning') {
        setTimeout(() => alert(message), 100);
    }
}

function showGeolocationHelp() {
    const currentUrl = `${location.protocol}//${location.hostname}:${location.port || (location.protocol === 'https:' ? '443' : '80')}`;
    
    const helpMessage = `Standortzugriff aktivieren:

AKTUELLE VERBINDUNG: ${currentUrl}
STATUS: ${location.protocol === 'https:' ? '‚úÖ HTTPS' : location.hostname === '127.0.0.1' || location.hostname === 'localhost' ? '‚ö†Ô∏è HTTP localhost (sollte funktionieren)' : '‚ùå HTTP (Geolocation blockiert)'}

Chrome/Edge:
1. Klicken Sie auf das Schloss/Info-Symbol links in der Adressleiste
2. W√§hlen Sie "Standort" ‚Üí "Zulassen"
3. Laden Sie die Seite neu (F5)

Firefox:
1. Klicken Sie auf das Schild-Symbol in der Adressleiste
2. Aktivieren Sie "Standort teilen"
3. Laden Sie die Seite neu

Safari:
1. Safari ‚Üí Einstellungen ‚Üí Websites ‚Üí Standort
2. W√§hlen Sie diese Website und "Zulassen"

FEHLERBEHEBUNG:
‚Ä¢ Browser neustarten
‚Ä¢ Inkognito-Modus testen
‚Ä¢ GPS/WLAN aktiviert?
‚Ä¢ F√ºr HTTPS: python app_https_robust.py verwenden`;

    alert(helpMessage);
}

// Global function to reset location button
function resetLocationButtonGlobal() {
    const button = document.getElementById('locationButton');
    if (button) {
        button.innerHTML = '<i class="fas fa-crosshairs"></i>';
        button.disabled = false;
    }
}

// Enhanced form functionality
function setupFormEnhancements() {
    const form = document.getElementById('searchForm');
    const locationInput = document.getElementById('location');
    
    // Auto-complete suggestions (mock data)
    setupLocationAutocomplete(locationInput);
    
    // Form submission enhancement
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (validateForm()) {
            saveSearchToHistory();
            showSearchProgress();
            
            // Submit with delay for better UX
            setTimeout(() => {
                this.submit();
            }, 500);
        }
    });
}

function setupLocationAutocomplete(input) {
    const suggestions = [
        'Berlin', 'Hamburg', 'M√ºnchen', 'K√∂ln', 'Frankfurt am Main',
        'Stuttgart', 'D√ºsseldorf', 'Leipzig', 'Dortmund', 'Essen',
        '10117', '20095', '80331', '50667', '60311'
    ];
    
    let suggestionsList;
    
    input.addEventListener('input', Utils.debounce(function() {
        const value = this.value.toLowerCase().trim();
        
        if (value.length < 2) {
            hideSuggestions();
            return;
        }
        
        const matches = suggestions.filter(s => 
            s.toLowerCase().includes(value)
        ).slice(0, 5);
        
        if (matches.length > 0) {
            showSuggestions(matches);
        } else {
            hideSuggestions();
        }
    }, 300));
    
    input.addEventListener('blur', () => {
        setTimeout(hideSuggestions, 150);
    });
    
    function showSuggestions(matches) {
        hideSuggestions();
        
        suggestionsList = document.createElement('div');
        suggestionsList.className = 'list-group position-absolute w-100';
        suggestionsList.style.zIndex = '1050';
        suggestionsList.style.top = '100%';
        suggestionsList.style.maxHeight = '200px';
        suggestionsList.style.overflowY = 'auto';
        
        matches.forEach(match => {
            const item = document.createElement('button');
            item.type = 'button';
            item.className = 'list-group-item list-group-item-action';
            item.innerHTML = `<i class="fas fa-map-marker-alt me-2"></i>${match}`;
            item.onclick = () => {
                input.value = match;
                hideSuggestions();
                input.focus();
            };
            suggestionsList.appendChild(item);
        });
        
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(suggestionsList);
    }
    
    function hideSuggestions() {
        if (suggestionsList) {
            suggestionsList.remove();
            suggestionsList = null;
        }
    }
}

function validateForm() {
    const location = document.getElementById('location').value.trim();
    const radius = parseInt(document.getElementById('radius').value);
    
    // Enhanced location validation
    if (!location) {
        Utils.showToast('Bitte geben Sie einen Standort ein', 'error');
        document.getElementById('location').focus();
        return false;
    }
    
    if (location.length < 2) {
        Utils.showToast('Standort muss mindestens 2 Zeichen haben', 'error');
        document.getElementById('location').focus();
        return false;
    }
    
    // Radius validation
    if (radius < 1 || radius > 100) {
        Utils.showToast('Radius muss zwischen 1 und 100 km liegen', 'error');
        document.getElementById('radius').focus();
        return false;
    }
    
    return true;
}

function saveSearchToHistory() {
    const location = document.getElementById('location').value.trim();
    const radius = document.getElementById('radius').value;
    const saveSearch = document.getElementById('saveSearch').checked;
    
    if (!saveSearch) return;
    
    const recentSearches = Utils.storage.get('recentSearches') || [];
    const newSearch = {
        location,
        radius,
        timestamp: new Date().toISOString(),
        id: Utils.generateId()
    };
    
    // Remove duplicate
    const filtered = recentSearches.filter(s => 
        s.location !== location || s.radius !== radius
    );
    
    // Add new search at beginning
    filtered.unshift(newSearch);
    
    // Keep only last 10 searches
    const updated = filtered.slice(0, 10);
    
    Utils.storage.set('recentSearches', updated);
}

function showSearchProgress() {
    const button = document.getElementById('searchButton');
    Utils.setButtonLoading(button, true);
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Suche wird gestartet...';
    
    // Enhanced progress indication
    const progressSteps = [
        'Standort wird validiert...',
        'Google Maps wird kontaktiert...',
        'Makler werden gesucht...',
        'Weiterleitung zu Ergebnissen...'
    ];
    
    let currentStep = 0;
    const stepInterval = setInterval(() => {
        if (currentStep < progressSteps.length - 1) {
            currentStep++;
            button.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${progressSteps[currentStep]}`;
        } else {
            clearInterval(stepInterval);
        }
    }, 800);
}

// Radius control functions (enhanced)
function updateRadiusDisplay(value) {
    document.getElementById('radiusLabel').innerHTML = `<span class="fw-bold">${value} km</span>`;
    document.getElementById('radiusInput').value = value;
    
    // Color coding for radius
    const label = document.getElementById('radiusLabel');
    const numValue = parseInt(value);
    
    if (numValue <= 15) {
        label.className = 'text-success fw-bold';
    } else if (numValue <= 35) {
        label.className = 'text-warning fw-bold';
    } else {
        label.className = 'text-danger fw-bold';
    }
}

function updateRadiusSlider(value) {
    const numValue = Math.max(1, Math.min(100, parseInt(value) || 10));
    document.getElementById('radius').value = numValue;
    document.getElementById('radiusInput').value = numValue;
    updateRadiusDisplay(numValue);
}

// Keyboard shortcuts
function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Alt+S: Focus search
        if (e.altKey && e.key === 's') {
            e.preventDefault();
            document.getElementById('location').focus();
            Utils.showToast('Suchfeld fokussiert (Alt+S)', 'info');
        }
        
        // Alt+G: Get current location
        if (e.altKey && e.key === 'g') {
            e.preventDefault();
            getCurrentLocation();
        }
        
        // Enter in radius input: Submit form
        if (e.key === 'Enter' && e.target.id === 'radiusInput') {
            e.preventDefault();
            document.getElementById('searchForm').dispatchEvent(new Event('submit'));
        }
    });
}

// Legacy functions for backward compatibility
function updateRadiusLabel(value) {
    updateRadiusDisplay(value);
}

// Initialize on load
window.addEventListener('load', function() {
    // Performance tracking (nur Konsole-Log, Toast wird von app.js gehandelt)
    if ('performance' in window) {
        const perfData = performance.getEntriesByType('navigation')[0];
        if (perfData) {
            const loadTime = Math.round(perfData.loadEventEnd - perfData.fetchStart);
            console.log(`üöÄ Index page loaded in ${loadTime}ms`);
            // Toast entfernt - wird bereits von app.js global gehandelt
        }
    }
    
    // Hide page loader
    const pageLoader = document.querySelector('.page-loader');
    if (pageLoader) {
        setTimeout(() => {
            pageLoader.classList.add('hide');
        }, 1500);
    }
});
</script>
{% endblock %}
