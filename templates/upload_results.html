{% extends "base.html" %}

{% block title %}Upload Ergebnisse - Versicherungsmakler Finder{% endblock %}

{% block content %}
<div class="hero-section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="hero-content text-center">
                    <h1 class="display-4 fw-bold mb-4">
                        <i class="fas fa-check-circle text-success me-3"></i>
                        Upload erfolgreich!
                    </h1>
                    <p class="lead mb-4">
                        Ihre Excel-Datei wurde verarbeitet und {{ results.new_count }} neue Makler in 
                        <strong>{{ results.search_location }}</strong> ({{ results.search_radius }}km Radius) gefunden.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-5">
    <!-- Statistics Dashboard -->
    <div class="row mb-5">
        <div class="col-md-3 mb-3">
            <div class="card text-center border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="display-6 text-primary mb-2">
                        <i class="fas fa-list-ul"></i>
                    </div>
                    <h5 class="card-title">Bestehende Makler</h5>
                    <p class="display-6 fw-bold text-primary mb-0">{{ results.existing_count }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="display-6 text-success mb-2">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <h5 class="card-title">Neue Makler</h5>
                    <p class="display-6 fw-bold text-success mb-0">{{ results.new_count }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="display-6 text-warning mb-2">
                        <i class="fas fa-copy"></i>
                    </div>
                    <h5 class="card-title">Duplikate</h5>
                    <p class="display-6 fw-bold text-warning mb-0">{{ results.duplicate_count }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-center border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="display-6 text-info mb-2">
                        <i class="fas fa-sigma"></i>
                    </div>
                    <h5 class="card-title">Gesamt</h5>
                    <p class="display-6 fw-bold text-info mb-0">{{ results.existing_count + results.new_count }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-download me-2"></i>
                        Ergebnisse exportieren
                    </h5>
                    <div class="btn-group" role="group">
                        <a href="/export/excel?source=upload" class="btn btn-success btn-lg">
                            <i class="fas fa-file-excel me-2"></i>
                            Als Excel herunterladen
                        </a>
                        <a href="/export/json?source=upload" class="btn btn-primary btn-lg">
                            <i class="fas fa-file-code me-2"></i>
                            Als JSON herunterladen
                        </a>
                        <button class="btn btn-info btn-lg" onclick="sendToAPI()">
                            <i class="fas fa-paper-plane me-2"></i>
                            An API senden
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs for different views -->
    <ul class="nav nav-tabs" id="resultTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="new-tab" data-bs-toggle="tab" data-bs-target="#new" type="button" role="tab">
                <i class="fas fa-plus-circle me-2"></i>
                Neue Makler ({{ results.new_count }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="existing-tab" data-bs-toggle="tab" data-bs-target="#existing" type="button" role="tab">
                <i class="fas fa-list-ul me-2"></i>
                Bestehende Makler ({{ results.existing_count }})
            </button>
        </li>
        {% if results.duplicate_count > 0 %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="duplicates-tab" data-bs-toggle="tab" data-bs-target="#duplicates" type="button" role="tab">
                <i class="fas fa-copy me-2"></i>
                Duplikate ({{ results.duplicate_count }})
            </button>
        </li>
        {% endif %}
    </ul>

    <div class="tab-content mt-4" id="resultTabContent">
        <!-- New Brokers Tab -->
        <div class="tab-pane fade show active" id="new" role="tabpanel" aria-labelledby="new-tab">
            {% if results.new_brokers %}
                <div class="row">
                    {% for broker in results.new_brokers %}
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 border-0 shadow-sm broker-card">
                            <div class="card-header bg-light border-0">
                                <h6 class="card-title mb-0 fw-bold">
                                    <i class="fas fa-building me-2 text-success"></i>
                                    {{ broker.name or 'Unbekannt' }}
                                </h6>
                            </div>
                            <div class="card-body">
                                {% if broker.address %}
                                <p class="card-text mb-2">
                                    <i class="fas fa-map-marker-alt text-primary me-2"></i>
                                    {{ broker.address }}
                                </p>
                                {% endif %}
                                
                                {% if broker.phone %}
                                <p class="card-text mb-2">
                                    <i class="fas fa-phone text-info me-2"></i>
                                    <a href="tel:{{ broker.phone }}" class="text-decoration-none">{{ broker.phone }}</a>
                                </p>
                                {% endif %}
                                
                                {% if broker.email %}
                                <p class="card-text mb-2">
                                    <i class="fas fa-envelope text-warning me-2"></i>
                                    <a href="mailto:{{ broker.email }}" class="text-decoration-none">{{ broker.email }}</a>
                                </p>
                                {% endif %}
                                
                                {% if broker.website %}
                                <p class="card-text mb-2">
                                    <i class="fas fa-globe text-secondary me-2"></i>
                                    <a href="{{ broker.website }}" target="_blank" class="text-decoration-none">Website besuchen</a>
                                </p>
                                {% endif %}
                                
                                {% if broker.rating %}
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-star text-warning me-2"></i>
                                    <span class="fw-bold me-2">{{ broker.rating }}</span>
                                    {% if broker.user_ratings_total %}
                                    <small class="text-muted">({{ broker.user_ratings_total }} Bewertungen)</small>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <div class="display-1 text-muted mb-3">
                        <i class="fas fa-search"></i>
                    </div>
                    <h4>Keine neuen Makler gefunden</h4>
                    <p class="text-muted">In der angegebenen Zone wurden keine zusätzlichen Makler gefunden.</p>
                </div>
            {% endif %}
        </div>

        <!-- Existing Brokers Tab -->
        <div class="tab-pane fade" id="existing" role="tabpanel" aria-labelledby="existing-tab">
            {% if results.existing_brokers %}
                <div class="row">
                    {% for broker in results.existing_brokers %}
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 border-0 shadow-sm broker-card">
                            <div class="card-header bg-light border-0">
                                <h6 class="card-title mb-0 fw-bold">
                                    <i class="fas fa-building me-2 text-primary"></i>
                                    {{ broker.name or 'Unbekannt' }}
                                </h6>
                            </div>
                            <div class="card-body">
                                {% if broker.address %}
                                <p class="card-text mb-2">
                                    <i class="fas fa-map-marker-alt text-primary me-2"></i>
                                    {{ broker.address }}
                                </p>
                                {% endif %}
                                
                                {% if broker.phone %}
                                <p class="card-text mb-2">
                                    <i class="fas fa-phone text-info me-2"></i>
                                    <a href="tel:{{ broker.phone }}" class="text-decoration-none">{{ broker.phone }}</a>
                                </p>
                                {% endif %}
                                
                                {% if broker.email %}
                                <p class="card-text mb-2">
                                    <i class="fas fa-envelope text-warning me-2"></i>
                                    <a href="mailto:{{ broker.email }}" class="text-decoration-none">{{ broker.email }}</a>
                                </p>
                                {% endif %}
                                
                                {% if broker.website %}
                                <p class="card-text mb-2">
                                    <i class="fas fa-globe text-secondary me-2"></i>
                                    <a href="{{ broker.website }}" target="_blank" class="text-decoration-none">Website besuchen</a>
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <div class="display-1 text-muted mb-3">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <h4>Keine bestehenden Makler</h4>
                    <p class="text-muted">Keine gültigen Makler-Daten in der hochgeladenen Excel-Datei gefunden.</p>
                </div>
            {% endif %}
        </div>

        <!-- Duplicates Tab -->
        {% if results.duplicate_count > 0 %}
        <div class="tab-pane fade" id="duplicates" role="tabpanel" aria-labelledby="duplicates-tab">
            <div class="alert alert-warning">
                <h6 class="fw-bold mb-2">
                    <i class="fas fa-info-circle me-2"></i>
                    Duplikate erkannt
                </h6>
                <p class="mb-0">Diese Makler wurden bereits in Ihrer Excel-Liste gefunden und daher nicht zu den neuen Ergebnissen hinzugefügt.</p>
            </div>
            
            <div class="row">
                {% for broker in results.duplicates %}
                <div class="col-lg-6 mb-4">
                    <div class="card h-100 border-warning shadow-sm broker-card">
                        <div class="card-header bg-warning bg-opacity-10 border-0">
                            <h6 class="card-title mb-0 fw-bold">
                                <i class="fas fa-copy me-2 text-warning"></i>
                                {{ broker.name or 'Unbekannt' }}
                            </h6>
                        </div>
                        <div class="card-body">
                            {% if broker.address %}
                            <p class="card-text mb-2">
                                <i class="fas fa-map-marker-alt text-primary me-2"></i>
                                {{ broker.address }}
                            </p>
                            {% endif %}
                            
                            {% if broker.phone %}
                            <p class="card-text mb-2">
                                <i class="fas fa-phone text-info me-2"></i>
                                {{ broker.phone }}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Back to Upload -->
    <div class="text-center mt-5">
        <a href="/upload" class="btn btn-outline-primary btn-lg">
            <i class="fas fa-upload me-2"></i>
            Neue Datei hochladen
        </a>
        <a href="/" class="btn btn-outline-secondary btn-lg ms-2">
            <i class="fas fa-home me-2"></i>
            Zur Startseite
        </a>
    </div>
</div>

<script>
// Store data in JavaScript variables safely
window.uploadResults = {
    existing_brokers: {{ results.existing_brokers | tojson | safe }},
    new_brokers: {{ results.new_brokers | tojson | safe }},
    duplicates: {{ results.duplicates | tojson | safe }},
    search_location: '{{ results.search_location }}',
    search_radius: {{ results.search_radius }}
};

async function sendToAPI() {
    try {
        // Safe toast function
        function showSafeToast(message, type = 'info') {
            try {
                if (typeof Utils !== 'undefined' && Utils.showToast) {
                    Utils.showToast(message, type);
                } else {
                    console.log(`${type.toUpperCase()}: ${message}`);
                    if (type === 'error') {
                        alert(message);
                    }
                }
            } catch (e) {
                console.log(`${type.toUpperCase()}: ${message}`);
            }
        }
        
        showSafeToast('Sende Daten an API...', 'info');
        
        // Get current API settings
        const settingsResponse = await fetch('/api/settings');
        const settings = await settingsResponse.json();
        
        if (!settings.api_url) {
            showSafeToast('Keine API-URL konfiguriert. Bitte besuchen Sie die API-Einstellungen.', 'error');
            return;
        }
        
        // Prepare data for API
        const apiData = {
            source: 'upload',
            existing_brokers: window.uploadResults.existing_brokers,
            new_brokers: window.uploadResults.new_brokers,
            duplicates: window.uploadResults.duplicates,
            search_params: {
                location: window.uploadResults.search_location,
                radius: window.uploadResults.search_radius
            }
        };
        
        // Send upload results to API
        const response = await fetch('/api/forward', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(apiData)
        });
        
        if (response.ok) {
            showSafeToast('Daten erfolgreich an API gesendet!', 'success');
        } else {
            const error = await response.json();
            showSafeToast(`API-Fehler: ${error.message}`, 'error');
        }
    } catch (error) {
        console.error('API send error:', error);
        try {
            if (typeof Utils !== 'undefined' && Utils.showToast) {
                Utils.showToast(`Fehler beim Senden: ${error.message}`, 'error');
            } else {
                alert(`Fehler beim Senden: ${error.message}`);
            }
        } catch (e) {
            console.log(`Fehler beim Senden: ${error.message}`);
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    try {
        // Initialize tooltips
        if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        
        // Animate statistics cards
        const cards = document.querySelectorAll('.card');
        cards.forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
            card.classList.add('fade-in-up');
        });
    } catch (error) {
        console.log('Upload results initialization error:', error);
    }
});
</script>
{% endblock %}
